<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programa de 21 D√≠as Amor Propio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuraci√≥n para usar la fuente Inter y tonos personalizados -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-indigo': '#5B21B6', // deep-indigo-700
                        'light-bg': '#F9FAFB', // very light gray
                        'day-card': '#EDE9FE', // light purple-100
                        'morning-card': '#FFFBEB', // yellow-50
                        'night-card': '#EEF2FF', // indigo-50
                        'success-green': '#10B981', // emerald-500
                        'rescue-red': '#DC2626', // red-600
                        'info-gray': '#9CA3AF', // gray-400 for info button
                        'week-focus': '#9333EA', // purple-700
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Estilos del bot√≥n de la cuadr√≠cula: SIN CAMBIOS */
        .day-button {
            transition: all 0.2s;
            aspect-ratio: 1 / 1; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .day-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .day-button:active {
            transform: translateY(0);
            box-shadow: none;
        }

        /* ESTILOS DE BOTONES DE ACCI√ìN (Compartido con estiramientos y rescate) */
        .action-button-style {
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .action-button-style:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .action-button-style:active {
            transform: translateY(0);
            box-shadow: none;
        }
        
        .modal-overlay {
            z-index: 50;
        }

        /* Estilo para el bot√≥n deshabilitado (no afecta la parte visual del dise√±o base) */
        .disabled-button {
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none !important;
            transform: none !important;
        }
    </style>
</head>
<body class="bg-light-bg font-sans min-h-screen">

    <!-- Contenido del Programa -->
    <div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- T√≠tulo principal -->
        <header class="text-center mb-6 mt-4">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-primary-indigo tracking-tight">
                Programa de 21 D√≠as Amor Propio
            </h1>
            <p class="mt-3 text-xl text-gray-600">
                Tu camino hacia la transformaci√≥n y el bienestar.
            </p>
            
            <!-- NUEVO: OBJETIVOS SEMANALES (A√±adido aqu√≠) -->
            <div class="mt-6 p-4 bg-white rounded-xl shadow-lg border-t-4 border-week-focus">
                <h2 class="text-xl font-extrabold text-week-focus mb-3">Objetivos por Semana</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-left">
                    <div class="p-2 bg-indigo-50 rounded-lg border-l-4 border-indigo-400">
                        <span class="text-xs font-semibold text-gray-600 block">Semana 1 (D√≠as 1-7)</span>
                        <span class="font-bold text-sm text-primary-indigo">Bienvenida y Gratitud</span>
                    </div>
                    <div class="p-2 bg-indigo-50 rounded-lg border-l-4 border-indigo-400">
                        <span class="text-xs font-semibold text-gray-600 block">Semana 2 (D√≠as 8-14)</span>
                        <span class="font-bold text-sm text-primary-indigo">Energ√≠a y Movimiento</span>
                    </div>
                    <div class="p-2 bg-indigo-50 rounded-lg border-l-4 border-indigo-400">
                        <span class="text-xs font-semibold text-gray-600 block">Semana 3 (D√≠as 15-21)</span>
                        <span class="font-bold text-sm text-primary-indigo">Transformaci√≥n y Sostenibilidad</span>
                    </div>
                    <!-- Adaptado a 3 semanas (21 d√≠as) -->
                    <div class="p-2 bg-indigo-50 rounded-lg border-l-4 border-indigo-400 hidden md:block opacity-0">
                        <span class="text-xs font-semibold text-gray-600 block">Semana 4</span>
                        <span class="font-bold text-sm text-primary-indigo">Cierre</span>
                    </div>
                    
                </div>
                <div class="mt-4 text-center">
                    <span class="text-sm font-bold text-week-focus">¬°Nota!</span> 
                    <span class="text-sm text-gray-700">El D√≠a 21 es la celebraci√≥n del proceso.</span>
                </div>
            </div>

            <!-- CONTENEDOR DE BOTONES DE ENCABEZADO -->
            <div class="mt-6 flex flex-col sm:flex-row items-center justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                
                <!-- BOT√ìN A√ëADIDO: Informaci√≥n sobre Fibromialgia -->
                <a href="https://fibroytransformacion.wixsite.com/fibromialgia/blog" target="_blank"
                   class="action-button-style px-4 py-2 bg-info-gray text-white font-extrabold rounded-full hover:bg-gray-500 transition duration-200 shadow-lg border-b-4 border-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-opacity-50 text-base sm:text-lg flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-6h2v6zm0-8h-2V7h2v4z"/>
                    </svg>
                    M√°s Informaci√≥n sobre Fibromialgia
                </a>

                <!-- BOT√ìN: Plan de Rescate (Mantiene el tama√±o reducido del paso anterior) -->
                <button onclick="openCrisisModal()" 
                        class="action-button-style px-4 py-2 bg-rescue-red text-white font-extrabold rounded-full hover:bg-red-700 transition duration-200 shadow-lg border-b-4 border-red-800 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 text-base sm:text-lg flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11.953 2C6.465 2 2 6.48 2 12s4.465 10 9.953 10c5.487 0 9.953-4.48 9.953-10S17.44 2 11.953 2zm-.99 15h1.98v-1.98h-1.98V17zm.058-2.973h.007c.552 0 .992-.44.992-.992v-4.004c0-.552-.44-.992-.992-.992h-.007c-.552 0-.992.44-.992.992v4.004c0 .552.44.992.992.992z"/>
                    </svg>
                    PLAN DE RESCATE (Crisis de Dolor)
                </button>
                
            </div>
            
        </header>

        <!-- Cuadr√≠cula de D√≠as (El Plano) -->
        <main class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 p-4 bg-white rounded-xl shadow-2xl">
            <!-- Los botones se generar√°n con JS -->
        </main>
    </div>

    <!-- MODAL 1: Contenido Diario -->
    <div id="dayContentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden modal-overlay items-center justify-center p-4" onclick="closeDayModal()">
        <div class="bg-white rounded-xl p-6 sm:p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto transform transition-all shadow-2xl" onclick="event.stopPropagation()">
            <div class="flex justify-between items-start mb-4">
                <h2 id="modalTitle" class="text-3xl font-bold text-primary-indigo"></h2>
                <button onclick="closeDayModal()" class="text-gray-400 hover:text-gray-700 transition duration-150">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <!-- Contenido Din√°mico (Espec√≠fico del D√≠a) -->
            <div id="modalDayContent" class="text-gray-700 leading-relaxed space-y-4 mb-8">
                <!-- Contenido espec√≠fico del d√≠a -->
            </div>
            
            <!-- Contenido Fijo (Rutinas, Estiramientos y Descarga) -->
            <div id="modalFixedRoutines" class="space-y-6 border-t pt-4">
                <!-- Aqu√≠ se inyectar√°n las rutinas, el bot√≥n de estiramientos y el de descarga (solo D√≠a 21) -->
            </div>

            <button onclick="closeDayModal()" class="mt-6 w-full py-3 bg-primary-indigo text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-200 shadow-md">
                Cerrar
            </button>
        </div>
    </div>
    
    <!-- MODAL 2: Protocolo de Crisis -->
    <div id="crisisProtocolModal" class="fixed inset-0 bg-black bg-opacity-50 hidden modal-overlay items-center justify-center p-4" onclick="closeCrisisModal()">
        <div class="bg-white rounded-xl p-6 sm:p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto transform transition-all shadow-2xl" onclick="event.stopPropagation()">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-3xl font-bold text-rescue-red flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11.953 2C6.465 2 2 6.48 2 12s4.465 10 9.953 10c5.487 0 9.953-4.48 9.953-10S17.44 2 11.953 2zm-.99 15h1.98v-1.98h-1.98V17zm.058-2.973h.007c.552 0 .992-.44.992-.992v-4.004c0-.552-.44-.992-.992-.992h-.007c-.552 0-.992.44-.992.992v4.004c0 .552.44.992.992.992z"/>
                    </svg>
                    Plan de Rescate en Crisis de Dolor
                </h2>
                <button onclick="closeCrisisModal()" class="text-gray-400 hover:text-gray-700 transition duration-150">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="text-gray-700 leading-relaxed space-y-4">
                <p class="font-semibold text-sm italic text-gray-600 border-b pb-2">
                    Este plan se activa cuando surge una crisis o un momento dif√≠cil. Est√° dise√±ado para ayudarte a evaluar, sostenerte y cuidar de ti misma con amor y conciencia.
                </p>

                <!-- 1. Eval√∫a la situaci√≥n -->
                <div class="p-3 bg-red-50 rounded-lg border-l-4 border-rescue-red">
                    <h3 class="font-extrabold text-xl text-rescue-red">1. Eval√∫a la Situaci√≥n</h3>
                    <p class="mt-1">Hazte esta pregunta:</p>
                    <p class="mt-1 font-bold italic">‚Äú¬øNecesito asistencia m√©dica o puedo manejarlo en casa?‚Äù</p>
                    <p class="text-sm mt-1">Si los s√≠ntomas son intensos o diferentes a lo habitual, **busca ayuda m√©dica**.</p>
                </div>
                
                <!-- 2. Si puedes manejarlo en casa -->
                <h3 class="font-extrabold text-xl text-primary-indigo border-b pb-1 pt-2">2. Si puedes manejarlo en casa...</h3>

                <!-- 3. Respira conscientemente -->
                <div class="p-3 bg-indigo-50 rounded-lg">
                    <h4 class="font-bold text-lg text-primary-indigo">3. Respira Consciente (3-5 minutos)</h4>
                    <p class="text-sm">Inhala contando **4**, ret√©n **2**, exhala **6**. Siente c√≥mo el aire limpia tu cuerpo desde dentro.</p>
                </div>

                <!-- 4. Conecta con un anclaje emocional -->
                <div class="p-3 bg-indigo-50 rounded-lg">
                    <h4 class="font-bold text-lg text-primary-indigo">4. Conecta con un Anclaje Emocional</h4>
                    <p class="text-sm">Toma algo suave o significativo (una piedra, peluche, amuleto). Recuerda: <span class="font-bold italic">‚ÄúEsto tambi√©n pasar√°‚Äù</span>.</p>
                </div>

                <!-- 5. M√∫sica sanadora o sonidos naturales -->
                <div class="p-3 bg-indigo-50 rounded-lg">
                    <h4 class="font-bold text-lg text-primary-indigo">5. M√∫sica Sanadora</h4>
                    <p class="text-sm">Elige melod√≠as suaves, cuencos tibetanos, olas del mar o sonidos del bosque; evita pantallas o noticias.</p>
                </div>

                <!-- 6. Aplica calor o fresco -->
                <div class="p-3 bg-indigo-50 rounded-lg">
                    <h4 class="font-bold text-lg text-primary-indigo">6. Aplica Calor o Fresco</h4>
                    <p class="text-sm">Compresas tibias para contracturas, fr√≠as para inflamaci√≥n. Hazlo con calma, cuid√°ndote desde el amor.</p>
                </div>

                <!-- 7. Visualizaci√≥n energ√©tica -->
                <div class="p-3 bg-indigo-50 rounded-lg">
                    <h4 class="font-bold text-lg text-primary-indigo">7. Visualizaci√≥n Energ√©tica</h4>
                    <p class="text-sm">Imagina una luz violeta recorriendo el √°rea afectada. Con cada respiraci√≥n, la luz **disuelve el dolor** y lo transforma en calma.</p>
                </div>

                <!-- Despu√©s de la crisis -->
                <h3 class="font-extrabold text-xl text-primary-indigo border-b pb-1 pt-2">Despu√©s de la Crisis</h3>
                <ul class="list-disc list-inside space-y-1 ml-4 text-sm">
                    <li>Anota qu√© sentiste y qu√© te ayud√≥ m√°s.</li>
                    <li>Agradece a tu cuerpo por resistir una vez m√°s.</li>
                    <li>Hazte una peque√±a promesa amorosa: <span class="font-bold italic">‚ÄúMa√±ana me cuidar√© un poquito m√°s.‚Äù</span></li>
                </ul>

                <!-- Intenci√≥n del plan -->
                <div class="p-3 bg-primary-indigo text-white rounded-lg mt-4">
                    <h4 class="font-extrabold text-lg">Intenci√≥n del Plan:</h4>
                    <p class="text-sm">No es para eliminar el dolor, sino para transformar tu relaci√≥n con √©l, aprender a escucharlo y responder con **compasi√≥n**, no con miedo. Es un recordatorio de tu fuerza interior.</p>
                </div>
            </div>

            <button onclick="closeCrisisModal()" class="mt-6 w-full py-3 bg-rescue-red text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200 shadow-md">
                Entendido, Cerrar Plan
            </button>
        </div>
    </div>
    
    <!-- Mensaje de Carga/Guardado -->
    <div id="loadingToast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-xl hidden z-50 transition duration-300">
        Cargando progreso...
    </div>

    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, getDocs, query, where, writeBatch, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Globales proporcionadas por el entorno
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
             apiKey: "AIzaSyBVudeIGPGEz-AMvWnbDZ16Hwru63mx1ok",
  authDomain: "programa-21-dias.firebaseapp.com",
  databaseURL: "https://programa-21-dias-default-rtdb.firebaseio.com",
  projectId: "programa-21-dias",
  storageBucket: "programa-21-dias.firebasestorage.app",
  messagingSenderId: "685743291261",
  appId: "1:685743291261:web:13ee6cff1bce8ccd782a14"
        };
        // Inicializaci√≥n corregida
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let isAuthReady = false;

        // Mostrar un mensaje temporal
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('loadingToast');
            toast.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, duration);
        }

        // --- INICIALIZACI√ìN DE FIREBASE ---
        async function initializeFirebase() {
            try {
                // setLogLevel('Debug'); // √ötil para depuraci√≥n
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticaci√≥n
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Esperar a que el estado de autenticaci√≥n cambie
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        // console.log("Firebase Auth Ready. User ID:", userId);
                    } else {
                        // Si falla la autenticaci√≥n, usar un ID aleatorio para almacenar (modo an√≥nimo/local)
                        userId = crypto.randomUUID();
                        isAuthReady = true;
                        // console.log("Firebase Auth Ready (Anonymous/Fallback). User ID:", userId);
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                showToast("Error al conectar la base de datos.");
            }
        }
        
        // --- UTILIDADES DE DATOS ---

        /**
         * Obtiene la referencia al documento de progreso de un d√≠a.
         * @param {number} dayIndex - El √≠ndice del d√≠a (0-20).
         * @returns {object} Referencia del documento de Firestore.
         */
        function getDayDocRef(dayIndex) {
            if (!userId || !appId) return null;
            const dayId = `day-${dayIndex + 1}`;
            // Path: /artifacts/{appId}/users/{userId}/challenge_progress/{day-X}
            return doc(db, 'artifacts', appId, 'users', userId, 'challenge_progress', dayId);
        }

        /**
         * Guarda el progreso de un d√≠a en Firestore.
         * @param {number} dayIndex - √çndice del d√≠a (0-20).
         * @param {string} field - El nombre del campo (e.g., 'morningAffirmation').
         * @param {string} value - El valor a guardar.
         * @param {number | null} activityIndex - √çndice de actividad para campos de array, o null.
         */
        async function saveProgress(dayIndex, field, value, activityIndex = null) {
            if (!isAuthReady) {
                console.warn("Base de datos no lista. No se pudo guardar.");
                return;
            }

            const docRef = getDayDocRef(dayIndex);
            if (!docRef) return;
            
            showToast("Guardando progreso...");

            try {
                // Obtener el documento actual para manejar arrays (dayActivities)
                const docSnap = await getDoc(docRef);
                let updateData = {};
                
                if (field === 'dayActivities') {
                    // Manejo de campos de tipo array
                    let activities = docSnap.exists() && docSnap.data().dayActivities ? docSnap.data().dayActivities : [];
                    // Asegurar que el array tenga al menos el tama√±o necesario
                    if (activityIndex >= activities.length) {
                        // Rellenar con cadenas vac√≠as si es necesario para mantener el √≠ndice
                        // Nota: El m√©todo map para asignar valores en el array es m√°s seguro
                        activities = Array.isArray(activities) ? activities : [];
                        activities[activityIndex] = value; 
                    } else {
                        activities[activityIndex] = value;
                    }
                    updateData[field] = activities;
                } else {
                    // Manejo de campos simples (string)
                    updateData[field] = value;
                }
                
                // Usar setDoc con merge: true para solo actualizar los campos necesarios
                await setDoc(docRef, updateData, { merge: true });
                // console.log(`Progreso guardado para el D√≠a ${dayIndex + 1}: ${field}`);
                showToast("Progreso guardado con √©xito.", 1500);

            } catch (error) {
                console.error("Error al guardar el progreso:", error);
                showToast("Error al guardar el progreso.", 3000);
            }
        }

        /**
         * Carga el progreso de un d√≠a y llena los campos del modal.
         * @param {number} dayIndex - √çndice del d√≠a (0-20).
         */
        async function loadDayProgress(dayIndex) {
            if (!isAuthReady) return;

            const docRef = getDayDocRef(dayIndex);
            if (!docRef) return;
            
            showToast("Cargando progreso...");

            try {
                const docSnap = await getDoc(docRef);
                const data = docSnap.exists() ? docSnap.data() : {};
                
                // Recorrer todos los elementos de entrada en el modal
                const modal = document.getElementById('dayContentModal'); // Usar el modal correcto
                const inputs = modal.querySelectorAll('textarea[data-field]');
                
                inputs.forEach(input => {
                    const field = input.dataset.field;
                    const activityIndex = input.dataset.activityIndex;
                    
                    if (field === 'dayActivities' && activityIndex !== undefined) {
                        // Llenar campos de actividad (si son arrays)
                        const index = parseInt(activityIndex, 10);
                        if (data.dayActivities && data.dayActivities.length > index) {
                            input.value = data.dayActivities[index] || '';
                        } else {
                            input.value = '';
                        }
                    } else if (data[field] !== undefined) {
                        // Llenar campos simples
                        input.value = data[field] || '';
                    } else {
                         input.value = '';
                    }
                });
                
                showToast("Progreso cargado con √©xito.", 1000);

            } catch (error) {
                console.error("Error al cargar el progreso:", error);
                showToast("Error al cargar el progreso.", 3000);
            }
        }

        /**
         * Adjunta listeners de guardado a todos los campos del modal.
         * @param {number} dayIndex - √çndice del d√≠a (0-20).
         */
        function attachInputListeners(dayIndex) {
            const modal = document.getElementById('dayContentModal');
            const inputs = modal.querySelectorAll('textarea[data-field]');
            
            inputs.forEach(input => {
                // Eliminar listener previo (si existe) para evitar duplicados
                input.onblur = null; 
                input.onblur = () => {
                    const field = input.dataset.field;
                    const value = input.value.trim();
                    const activityIndex = input.dataset.activityIndex !== undefined ? parseInt(input.dataset.activityIndex, 10) : null;
                    
                    saveProgress(dayIndex, field, value, activityIndex);
                };
            });
        }
        
        // --- L√ìGICA DE D√çA 21 Y BOTONES ---

        /**
         * Cuenta cu√°ntos d√≠as tienen al menos un registro de actividad.
         * Un d√≠a cuenta como activo si tiene al menos una de las siguientes: 
         * morningAffirmation, morningIntention, nightGratitude, o alguna entrada en dayActivities.
         * @returns {Promise<number>} N√∫mero de d√≠as activos.
         */
        async function countActiveDays() {
            if (!isAuthReady || !userId || !appId) return 0;

            const progressRef = collection(db, 'artifacts', appId, 'users', userId, 'challenge_progress');
            
            try {
                // Obtenemos todos los documentos de progreso
                const querySnapshot = await getDocs(progressRef);
                let activeDays = 0;

                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    // Comprobamos si hay al menos una entrada de texto
                    const hasAffirmation = data.morningAffirmation && data.morningAffirmation.trim() !== '';
                    const hasIntention = data.morningIntention && data.morningIntention.trim() !== '';
                    const hasGratitude = data.nightGratitude && data.nightGratitude.trim() !== '';
                    const hasActivities = data.dayActivities && data.dayActivities.some(a => a && a.trim() !== '');

                    if (hasAffirmation || hasIntention || hasGratitude || hasActivities) {
                        activeDays++;
                    }
                });
                // console.log("D√≠as activos contados:", activeDays);
                return activeDays;

            } catch (error) {
                console.error("Error contando d√≠as activos:", error);
                return 0;
            }
        }

        /**
         * Genera el bot√≥n de Comentario del D√≠a 21.
         * @param {number} activeDaysCount - N√∫mero de d√≠as con actividad registrada.
         * @returns {string} HTML del bot√≥n de Comentario.
         */
        function getCommentButtonHtml(activeDaysCount) {
            const requiredDays = 15;
            const isEnabled = activeDaysCount >= requiredDays;
            
            // Bot√≥n que siempre se muestra, pero se habilita visualmente y funcionalmente
            const enabledClasses = 'bg-success-green hover:bg-emerald-600 border-emerald-700';
            const disabledClasses = 'disabled-button bg-gray-400 border-gray-600';
            const classes = isEnabled ? enabledClasses : disabledClasses;
            const action = isEnabled ? 
                `showToast('¬°Felicitaciones! Enlace de rese√±a simulado. Abrir una nueva pesta√±a para el formulario.', 5000)` : 
                `showToast('Necesitas registrar tu actividad en al menos ${requiredDays} d√≠as para desbloquear el comentario. Llevas ${activeDaysCount} d√≠as.', 5000)`;

            return `
                <div class="mt-8 pt-4 border-t border-gray-200">
                    <h3 class="font-bold text-lg text-primary-indigo mb-3 text-center">¬°Celebra tu Transformaci√≥n!</h3>
                    <button onclick="${action}"
                            class="action-button-style block w-full text-center py-4 px-4 text-white font-extrabold rounded-xl transition duration-200 shadow-xl border-b-4 ${classes}">
                        <span class="text-xl leading-none">Comentar tu Experiencia</span>
                        <span class="block mt-1 text-xs font-medium opacity-90">${isEnabled ? '(Bot√≥n Desbloqueado)' : `(Actividad: ${activeDaysCount}/${requiredDays} d√≠as)`}</span>
                    </button>
                </div>
            `;
        }
        
        // --- L√ìGICA DE DESCARGA ---
        
        /**
         * Genera y descarga un archivo TXT con todo el progreso del usuario.
         */
        async function downloadProgress() {
            if (!isAuthReady || !userId || !appId) return showToast("Error de autenticaci√≥n, no se puede descargar.");
            
            showToast("Recopilando datos para la descarga...");

            const progressRef = collection(db, 'artifacts', appId, 'users', userId, 'challenge_progress');
            
            try {
                const querySnapshot = await getDocs(progressRef);
                let progressData = {};
                
                querySnapshot.forEach(docSnap => {
                    const dayId = docSnap.id;
                    progressData[dayId] = docSnap.data();
                });

                // Ordenar los datos por n√∫mero de d√≠a
                const sortedDays = Object.keys(progressData)
                    .sort((a, b) => parseInt(a.split('-')[1]) - parseInt(b.split('-')[1]));

                let fileContent = "DIARIO DE TRANSFORMACI√ìN - PROGRAMA 21 D√çAS AMOR PROPIO\n";
                fileContent += `Usuario ID: ${userId}\n`;
                fileContent += `Fecha de Descarga: ${new Date().toLocaleDateString()}\n\n`;
                fileContent += "=================================================\n\n";

                sortedDays.forEach(dayId => {
                    const dayNumber = dayId.split('-')[1];
                    const data = progressData[dayId];
                    const dayTitle = dailyContent[dayNumber - 1] ? dailyContent[dayNumber - 1].title : `D√≠a ${dayNumber}`;
                    
                    fileContent += `\n--- ${dayTitle} ---\n`;
                    fileContent += `  Afirmaci√≥n Matutina: ${data.morningAffirmation || 'No registrado'}\n`;
                    fileContent += `  Intenci√≥n del D√≠a: ${data.morningIntention || 'No registrado'}\n`;
                    fileContent += `  Gratitud Nocturna: ${data.nightGratitude || 'No registrado'}\n`;
                    
                    if (data.dayActivities && data.dayActivities.length > 0) {
                        fileContent += "  Otras Actividades/Diario:\n";
                        data.dayActivities.forEach((activity, index) => {
                            if (activity && activity.trim() !== '') {
                                fileContent += `    - [Entrada ${index + 1}]: ${activity}\n`;
                            }
                        });
                    }
                });

                // Crear y descargar el archivo TXT
                const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Progreso_21_Dias_Amor_Propio_${new Date().toLocaleDateString()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast("Descarga completada.", 1500);

            } catch (error) {
                console.error("Error durante la descarga:", error);
                showToast("Error al procesar la descarga de datos.", 3000);
            }
        }

        // --- MANEJO DE MODALES ---

        const dayContentModal = document.getElementById('dayContentModal');
        const crisisProtocolModal = document.getElementById('crisisProtocolModal');

        /**
         * Cierra el modal de contenido diario.
         */
        function closeDayModal() {
            dayContentModal.classList.add('hidden');
            dayContentModal.classList.remove('flex');
        }

        /**
         * Abre el modal del protocolo de crisis.
         */
        function openCrisisModal() {
            crisisProtocolModal.classList.remove('hidden');
            crisisProtocolModal.classList.add('flex');
        }

        /**
         * Cierra el modal del protocolo de crisis.
         */
        function closeCrisisModal() {
            crisisProtocolModal.classList.add('hidden');
            crisisProtocolModal.classList.remove('flex');
        }

        // --- CONSTANTE DE RUTINA NOCTURNA (Incluye campo de texto para Gratitud) ---
        // ¬°ENLACE DE YOUTUBE CORREGIDO EN EL PASO ANTERIOR!
        const BASE_NIGHT_RELAXATION = `
            <div class="p-4 rounded-xl shadow-md bg-night-card border-l-4 border-indigo-500">
                <h3 class="font-bold text-xl text-indigo-700 mb-3 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM12 20c-4.41 0-8-3.59-8-8 0-.91.15-1.79.41-2.61C6.2 12.18 8.92 14 12 14c3.08 0 5.8-1.82 7.59-4.61.26.82.41 1.7.41 2.61 0 4.41-3.59 8-8 8z"/>
                    </svg>
                    Rutina de Noche: Descanso Sagrado
                </h3>
                <p class="text-gray-700 mb-3 text-sm">Prepara tu cuerpo para el sue√±o reparador con esta meditaci√≥n de respiraci√≥n guiada (el recurso constante para cada d√≠a):</p>
                <a href="https://youtu.be/l-Y3yUNlMyI?si=xfooZCkpEvdzL5Zj" target="_blank" 
                   class="block w-full py-3 bg-indigo-200 text-indigo-800 font-semibold rounded-lg text-center text-sm hover:bg-indigo-300 transition shadow-inner">
                    ‚ñ∂Ô∏è Click aqu√≠: Respiraci√≥n Guiada Nocturna (YouTube)
                </a>
                <ul class="list-disc list-inside space-y-1 text-gray-700 ml-4 text-sm mt-3">
                    <li>**Apagado Digital:** Deja las pantallas 1 hora antes de dormir.</li>
                    <li>**Revisi√≥n de Gratitud:** Escribe o piensa en 3 cosas buenas que te pasaron.</li>
                </ul>
                <!-- Campo de texto a√±adido para registrar la gratitud con data-field -->
                <textarea class="w-full mt-2 p-2 border border-indigo-400 rounded-lg text-sm text-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" rows="3" placeholder="Escribe aqu√≠ tus 3 momentos de gratitud del d√≠a..." data-field="nightGratitude"></textarea>
            </div>
        `;
        
        // --- BOT√ìN DE DESCARGA DE PROGRESO (SE MOSTRAR√Å CONDICIONALMENTE) ---
        const DOWNLOAD_BUTTON_HTML = `
            <div class="mt-6 mb-4">
                <button onclick="downloadProgress()"
                    class="action-button-style block w-full text-center py-3 px-4 bg-primary-indigo text-white font-extrabold rounded-xl hover:bg-indigo-700 transition duration-200 shadow-xl border-b-4 border-indigo-900">
                    <span class="text-xl leading-none">üíæ Descargar mi Archivo de Progreso</span>
                    <span class="block mt-1 text-xs font-medium opacity-90">(Incluye todas tus entradas de diario y rutinas)</span>
                </button>
            </div>
        `;

        // --- NUEVO BOT√ìN PARA EJERCICIOS DE ESTIRAMIENTO ---
        const STRETCHING_BUTTON_HTML = `
            <div class="mt-6 mb-6">
                <a href="https://youtu.be/xAHqX0ZfLsA?si=6wxjVExoOeG2lORG" target="_blank"
                   class="action-button-style block w-full text-center py-4 px-4 bg-emerald-500 text-white font-extrabold rounded-xl hover:bg-emerald-600 transition duration-200 shadow-xl border-b-4 border-emerald-700">
                    <span class="text-xl leading-none">Ejercicios de Estiramiento</span>
                    <span class="block mt-1 text-xs font-medium opacity-90">(Sugerencia: 3 veces por semana)</span>
                </a>
            </div>
        `;
        
        // --- FUNCI√ìN PARA GENERAR LA RUTINA DE LA MA√ëANA DIN√ÅMICA ---
        function getMorningRoutineHtml(dayIndex) {
            const dayPrompt = morningPrompts[dayIndex];
            if (!dayPrompt) return ''; 

            return `
                <div class="p-4 rounded-xl shadow-md bg-morning-card border-l-4 border-yellow-500">
                    <h3 class="font-bold text-xl text-yellow-700 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M11 21h2v-2h-2v2zm0-4h2v-6h-2v6zm.94-11.45L12 3l.06.55c.34 2.89 2.5 5.3 5.39 5.64L21 9l-3.32 3.32c-.7.7-1.66 1.07-2.68 1.07H7.01c-.01 0-.02 0-.03 0L3 13l3.85-3.85c2.61-2.61 3.51-5.75 3.12-8.15z"/>
                        </svg>
                        Rutina de la Ma√±ana: Intenci√≥n y Luz
                    </h3>
                    
                    <!-- 1. Meditaci√≥n Guiada Matutina -->
                    <div class="mb-5">
                        <p class="font-semibold text-gray-700">Meditaci√≥n Guiada Matutina:</p>
                        <a href="https://youtu.be/tmR2zBgaoSM?si=6wxjVExoOeG2lORG" target="_blank"
                            class="text-blue-600 hover:text-blue-800 underline block mt-1 font-medium">
                            ‚ñ∂Ô∏è Click aqu√≠: Respiraci√≥n Matutina (YouTube)
                        </a>
                    </div>

                    <!-- 2. Afirmaci√≥n del D√≠a (Sugerencia + Input) -->
                    <div class="mb-5">
                        <p class="font-semibold text-gray-700">Afirmaci√≥n:</p>
                        <p class="text-sm italic text-gray-600">Sugerencia para el D√≠a ${dayIndex + 1}: "${dayPrompt.affirmation}"</p>
                        <!-- Afirmaci√≥n con data-field para guardar -->
                        <textarea class="w-full mt-2 p-2 border border-yellow-400 rounded-lg text-sm text-gray-700 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition duration-150" rows="1" placeholder="Repite tu afirmaci√≥n del d√≠a o escribe la tuya..." data-field="morningAffirmation"></textarea>
                    </div>

                    <!-- 3. Establecer Intenci√≥n (Sugerencia + Input) -->
                    <div class="mb-1">
                        <p class="font-semibold text-gray-700">Establece una intenci√≥n para tu d√≠a:</p>
                        <p class="text-sm italic text-gray-600">Sugerencia para el D√≠a ${dayIndex + 1}: "${dayPrompt.intentionSuggestion}"</p>
                         <!-- Intenci√≥n con data-field para guardar -->
                        <textarea class="w-full mt-2 p-2 border border-yellow-400 rounded-lg text-sm text-gray-700 focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition duration-150" rows="1" placeholder="Escribe tu intenci√≥n personal para hoy..." data-field="morningIntention"></textarea>
                    </div>
                </div>
            `;
        }

        // --- PROMPTS DE AFIRMACI√ìN E INTENCI√ìN DIN√ÅMICOS (21 D√çAS) ---
        const morningPrompts = [
            { affirmation: "Merezco este tiempo de sanaci√≥n.", intentionSuggestion: "Enfocarme en la gratitud por mi cuerpo."}, // D√≠a 1
            { affirmation: "Mi voz es importante y la honro.", intentionSuggestion: "Usar mis frases de amor propio."}, // D√≠a 2
            { affirmation: "Estoy presente en mi cuerpo ahora.", intentionSuggestion: "Practicar la calma en cada respiraci√≥n."}, // D√≠a 3
            { affirmation: "Mi cuerpo me habla, yo lo escucho.", intentionSuggestion: "Responder a la necesidad de mi cuerpo."}, // D√≠a 4
            { affirmation: "Cada experiencia nueva es una semilla de vida.", intentionSuggestion: "Atreverme a probar algo nuevo con curiosidad."}, // D√≠a 5
            { affirmation: "Me nutro con conciencia y amor.", intentionSuggestion: "Beber agua con intenci√≥n de sanaci√≥n."}, // D√≠a 6
            { affirmation: "Cada bocado puede ser una caricia al alma.", intentionSuggestion: "Comer despacio, sintiendo el sabor y textura."}, // D√≠a 7
            { affirmation: "Dejo ir el juicio, abrazo la sensaci√≥n.", intentionSuggestion: "Observar mi cuerpo sin cr√≠tica."}, // D√≠a 8 
            { affirmation: "Moverme es honrar mi energ√≠a.", intentionSuggestion: "Disfrutar del movimiento suave y consciente."}, // D√≠a 9
            { affirmation: "Hoy me trato con la misma bondad que ofrezco a otros.", intentionSuggestion: "Escribir una carta de perd√≥n y compasi√≥n hacia m√≠ misma."}, // D√≠a 10 
            { affirmation: "Mi descanso es productivo y necesario.", intentionSuggestion: "Preparar mi mente para un sue√±o profundo."}, // D√≠a 11
            { affirmation: "Soy mi mejor amiga, hablo con bondad.", intentionSuggestion: "Transformar un pensamiento cr√≠tico en amoroso."}, // D√≠a 12
            { affirmation: "Merezco ser escuchado y comprendido.", intentionSuggestion: "Establecer mi intenci√≥n de comunicarme con claridad y amor."}, // D√≠a 13
            { affirmation: "Celebro mis avances, por peque√±os que sean.", intentionSuggestion: "Reconocer un logro de la semana."}, // D√≠a 14
            { affirmation: "Mis manos me dan consuelo y afecto.", intentionSuggestion: "Darme un momento de cuidado y tacto."}, // D√≠a 15
            { affirmation: "Permito que mis emociones fluyan y se liberen.", intentionSuggestion: "Escribir sin censura lo que siento."}, // D√≠a 16
            { affirmation: "La luz sanadora me llena de vitalidad.", intentionSuggestion: "Visualizar la salud y la calma en mi interior."}, // D√≠a 17
            { affirmation: "Mi gratitud expande mi bienestar.", intentionSuggestion: "Agradecer por 5 cosas inesperadas."}, // D√≠a 18
            { affirmation: "Mi postura refleja mi fuerza interna.", intentionSuggestion: "Recordar mi alineaci√≥n y fuerza a cada hora."}, // D√≠a 19
            { affirmation: "Soy una guerrera valiente y amorosa.", intentionSuggestion: "Reconocer el camino que he recorrido."}, // D√≠a 20
            { affirmation: "Mi renacimiento est√° aqu√≠ y es poderoso.", intentionSuggestion: "Honrar mi proceso y celebrar mi nueva yo."} // D√≠a 21
        ];

        // --- CONTENIDO ESPEC√çFICO DE LOS D√çAS (Extra√≠do de tu PDF) ---
        const dailyContent = [
            { title: "D√≠a 1: Bienvenida y Gratitud", content: `<p class="italic mb-3 font-semibold text-gray-600">"Est√°s dando el paso m√°s valiente: sanar desde el amor".</p><h3 class="font-bold text-lg text-primary-indigo mt-3">‚úÖ Ejercicio:</h3><p>Escribe 3 cosas por las que agradeces a tu cuerpo hoy.</p><h3 class="font-bold text-lg text-primary-indigo mt-3">‚úçÔ∏è Diario:</h3><p>¬øQu√© emociones te genera comenzar este proceso?</p>` },
            { title: "D√≠a 2: Frases de Amor Propio", content: `<h3 class="font-bold text-lg text-primary-indigo">‚úÖ Tarea:</h3><p>Crea 5 poderosas frases (ej. "Merezco descanso sin culpa", "Mi cuerpo no me traiciona, me comunica").</p><p>Col√≥calas en espejos, paredes o tu rinc√≥n favorito.</p><h3 class="font-bold text-lg text-primary-indigo mt-3">‚úçÔ∏è Diario:</h3><p>¬øC√≥mo cambia tu √°nimo al leerlas cada d√≠a?</p>` },
            { title: "D√≠a 3: Respiraci√≥n Consciente y Presencia", content: `<h3 class="font-bold text-lg text-primary-indigo">‚úÖ Pr√°ctica:</h3><p>5 minutos, tres veces al d√≠a. Inhala en 4 tiempos, ret√©n 2, exhala en 6. Visualiza: con cada exhalaci√≥n, liberas tensi√≥n y cansancio.</p><p>Ap√≥yate con m√∫sica suave o sonidos naturales.</p>` },
            { title: "D√≠a 4: Escucha Activa del Cuerpo", content: `<h3 class="font-bold text-lg text-primary-indigo">‚úÖ Ejercicio:</h3><p>Si√©ntate en silencio 5 minutos. Lleva la atenci√≥n a distintas partes del cuerpo. Preg√∫ntate: "¬øQu√© necesita hoy esta parte de m√≠?"</p><p>Anota sensaciones sin juzgarlas.</p><p class="text-xs italic mt-2 text-gray-500">Recordatorio: La hidrataci√≥n se mantiene como apoyo diario.</p>` },
            { title: "D√≠a 5: Atreverse a lo Nuevo", content: `<h3 class="font-bold text-lg text-primary-indigo">üåü Afirmaci√≥n:</h3><p>"Cada experiencia nueva es una semilla de vida."</p><h3 class="font-bold text-lg text-primary-indigo mt-3">‚úÖ Pr√°ctica:</h3><p>Prueba algo que nunca hayas hecho: una comida nueva, visita un sitio diferente de tu localidad, o cambia tu rutina de hoy.</p><h3 class="font-bold text-lg text-primary-indigo mt-3">‚úçÔ∏è Diario:</h3><p>¬øQu√© hiciste de nuevo hoy? ¬øQu√© emociones experimentaste al salir de tu zona de confort?</p>` },
            { title: "D√≠a 6: Hidrataci√≥n Consciente", content: `<h3 class="font-bold text-lg text-primary-indigo">‚úÖ Enfoque Diario:</h3><p>Cada vaso de agua que tomes hoy, t√≥malo con la intenci√≥n de nutrir, limpiar y calmar tu cuerpo. Manten la botella cerca de ti.</p><h3 class="font-bold text-lg text-primary-indigo mt-3">‚úçÔ∏è Diario:</h3><p>¬øC√≥mo se siente tu cuerpo al recibir este cuidado intencional?</p>` },
            { title: "D√≠a 7: Alimentaci√≥n Consciente", content: `<h3 class="font-bold text-lg text-primary-indigo">üåü Afirmaci√≥n:</h3><p>"Cada bocado puede ser una caricia al alma."</p><h3 class="font-bold text-lg text-primary-indigo mt-3">‚úÖ Actividad:</h3><p>Antes de comer, observa tus alimentos y come despacio, percibiendo su sabor y textura. Habla a tus alimentos y agrad√©celes por nutrirte.</p><h3 class="font-bold text-lg text-primary-indigo mt-3">‚úçÔ∏è Diario:</h3><p>¬øQu√© sabores y texturas descubriste al comer despacio? ¬øC√≥mo se sinti√≥ tu cuerpo al agradecer la comida?</p>` },
            { title: "D√≠a 8: Tiempo de calidad compartido", content: `<h3 class="font-bold text-lg text-primary-indigo">üåü Afirmaci√≥n:</h3><p>"Compartir tambi√©n es sanar."</p><h3 class="font-bold text-lg text-primary-indigo mt-3">‚úÖ Ejercicio:</h3><p>Pasa un momento agradable con tu mascota, un amigo o familiar. Sal a caminar con √©l/ella si es posible. Habla de temas que te hagan sonre√≠r.</p><h3 class="font-bold text-lg text-primary-indigo mt-3">‚úçÔ∏è Diario:</h3><p>¬øC√≥mo se sinti√≥ la energ√≠a que compartiste? ¬øQu√© descubriste de ti al compartir con otro?</p>` },
            { title: "D√≠a 9: Movimiento Suave (Caminata)", content: `<h3 class="font-bold text-lg text-primary-indigo">‚úÖ Ejercicio:</h3><p>Realiza una caminata de 15 minutos a un ritmo muy lento y c√≥modo. Se trata de mover la energ√≠a estancada. Si no puedes caminar, haz movimientos suaves de brazos y cuello.</p><p class="mt-2">Detente si sientes fatiga o dolor intenso.</p>` },
            { title: "D√≠a 10: Compasi√≥n hacia m√≠ misma", content: `<h3 class="font-bold text-lg text-primary-indigo">üåü Afirmaci√≥n:</h3><p>"Hoy me trato con la misma bondad que ofrezco a otros.‚Äù</p><h3 class="font-bold text-lg text-primary-indigo mt-3">‚úÖ Pr√°ctica:</h3><p>Escr√≠bete una carta de perd√≥n por los momentos en los que no te priorizaste.</p><h3 class="font-bold text-lg text-primary-indigo mt-3">‚úçÔ∏è Diario:</h3><p>¬øQu√© emociones te gener√≥ escribir esta carta? ¬øQu√© acto de bondad te regalar√°s hoy?</p>` },
            { title: "D√≠a 11: La Importancia del Sue√±o", content: `<h3 class="font-bold text-lg text-primary-indigo">‚úÖ Rutina Nocturna:</h3><p>Aseg√∫rate de acostarte a la misma hora y evitar luces azules al menos 30 minutos antes de dormir. Bebe una infusi√≥n de manzanilla o lavanda.</p><h3 class="font-bold text-lg text-primary-indigo mt-3">‚úçÔ∏è Diario:</h3><p>Anota tu calidad de sue√±o y c√≥mo afecta tu d√≠a.</p>` },
            { title: "D√≠a 12: Di√°logo Interno Positivo", content: `<h3 class="font-bold text-lg text-primary-indigo">‚úÖ Pr√°ctica:</h3><p>Convi√©rtete en tu mejor amiga/o. Cada vez que te detectes un pensamiento autocr√≠tico, detente y reform√∫lalo en algo compasivo y realista.</p><p>Por ejemplo: "Soy suficiente tal y como soy hoy."</p>` },
            { 
                title: "D√≠a 13: Comunicaci√≥n Consciente con tu cuidador", 
                content: `<h3 class="font-bold text-lg text-primary-indigo">‚úÖ T√©cnica: ‚ÄúYo siento + necesito + propongo‚Äù</h3>
                          <p class="text-sm italic text-gray-600 mb-3">Esta t√©cnica te permite expresar tu experiencia y tu necesidad de forma clara y respetuosa.</p>
                          <h4 class="font-bold text-md text-primary-indigo mt-3">Ejemplo:</h4>
                          <p class="text-gray-700 italic">‚ÄúYo siento frustraci√≥n cuando no puedo moverme, necesito tu comprensi√≥n, propongo que respiremos juntos unos minutos‚Äù.</p>
                          <h3 class="font-bold text-lg text-primary-indigo mt-3">‚úÖ Acci√≥n del D√≠a:</h3>
                          <p>Habla hoy con tu cuidador en un momento de calma que est√© receptivo y manifiesta tu necesidad m√°s importante utilizando esta t√©cnica.</p>
                          <h3 class="font-bold text-lg text-primary-indigo mt-3">‚úçÔ∏è Diario:</h3>
                          <p>¬øCu√°l fue la necesidad que lograste comunicar? ¬øC√≥mo te sientes despu√©s de haberla expresado?</p>` 
            },
            { title: "D√≠a 14: Recapitulaci√≥n Semanal", content: `<h3 class="font-bold text-lg text-primary-indigo">‚úÖ Revisi√≥n:</h3><p>Relee tu diario de la √∫ltima semana. Identifica tu mayor reto y tu mayor avance.</p><h3 class="font-bold text-lg text-primary-indigo mt-3">üéØ Meta:</h3><p>Elige una pr√°ctica de esta semana para integrarla en tu rutina diaria.</p>` },
            { title: "D√≠a 15: Masaje de Manos y Pies", content: `<h3 class="font-bold text-lg text-primary-indigo">‚úÖ Pr√°ctica:</h3><p>Usa una crema con olor agradable. Dedica 5 minutos a masajear suavemente tus manos y luego tus pies. Usa movimientos lentos y circulares.</p><p>Esto ayuda a liberar tensi√≥n en puntos clave.</p>` },
            { title: "D√≠a 16: Liberaci√≥n Emocional", content: `<h3 class="font-bold text-lg text-primary-indigo">‚úçÔ∏è Diario:</h3><p>Escribe sobre cualquier emoci√≥n (tristeza, rabia, frustraci√≥n) que hayas estado reprimiendo. No la juzgues, solo d√©jala salir en el papel.</p><p>Luego, rompe o quema el papel (con cuidado) como s√≠mbolo de liberaci√≥n.</p>` },
            { title: "D√≠a 17: Visualizaci√≥n Sanadora", content: `<h3 class="font-bold text-lg text-primary-indigo">‚úÖ Meditaci√≥n Guiada:</h3><p>Cierra los ojos e imagina una luz c√°lida y sanadora que entra por tu cabeza y recorre cada parte de tu cuerpo. Visualiza c√≥mo esta luz calma el dolor y devuelve la vitalidad.</p><p>Mantente en esta visualizaci√≥n por 10 minutos.</p>` },
            { title: "D√≠a 18: La Gratitud Expansiva", content: `<h3 class="font-bold text-lg text-primary-indigo">‚úÖ Ejercicio:</h3><p>Adem√°s de tu cuerpo, nombra 5 cosas externas (personas, momentos, objetos) por las que sientes profunda gratitud hoy. Siente esa emoci√≥n en tu pecho.</p><p>La gratitud eleva la vibraci√≥n y ayuda a manejar el dolor.</p>` },
            { title: "D√≠a 19: Cuidado de la Postura", content: `<h3 class="font-bold text-lg text-primary-indigo">‚úÖ Conciencia Corporal:</h3><p>A lo largo del d√≠a, haz una pausa de 30 segundos cada hora. Chequea tu postura: hombros relajados, espalda recta, ment√≥n paralelo al suelo.</p><p><strong>Mini-Afirmaci√≥n:</strong> "Mi cuerpo es fuerte y alineado."</p>` },
            { title: "D√≠a 20: Celebraci√≥n del Proceso", content: `<p class="italic mb-3 font-semibold text-gray-600">"He caminado con valor".</p><h3 class="font-bold text-lg text-primary-indigo">‚úÖ Reconocimiento:</h3><p>Escribe una carta de amor y gratitud a tu cuerpo por su resistencia, su mensaje y por haberte acompa√±ado en este proceso.</p><h3 class="font-bold text-lg text-primary-indigo mt-3">‚úçÔ∏è Diario:</h3><p>¬øQu√© le dir√≠as a la versi√≥n de ti que comenz√≥ este proceso hace 20 d√≠as?</p>` },
            { title: "D√≠a 21: Ritual de Cierre y Renacimiento", content: `<h3 class="font-bold text-lg text-primary-indigo">‚úÖ Ritual:</h3><p>Prepara una vela morada y enci√©ndela con esta intenci√≥n: <strong>"Transformo el dolor en sabidur√≠a. Soy luz, soy fuerza, soy renacimiento".</strong></p><p>Coloca tu diario y tus frases a tu alrededor. Respira, sonr√≠e y honra tu camino.</p><h3 class="font-extrabold text-2xl text-primary-indigo mt-4 text-center">¬°Felicitaciones! ¬°Lo lograste guerrer@!</h3><!-- COMENTARIO BUTTON INJECTED HERE -->` }
        ];

        const gridContainer = document.querySelector('main');
        const modalTitle = document.getElementById('modalTitle');
        const modalDayContent = document.getElementById('modalDayContent');
        const modalFixedRoutines = document.getElementById('modalFixedRoutines');

        
        /**
         * Inicializa la cuadr√≠cula de 21 d√≠as.
         */
        function initializeGrid() {
            dailyContent.forEach((day, index) => {
                const dayNumber = index + 1;
                const button = document.createElement('div');
                
                // Determinar el objetivo semanal para el color de fondo y borde (visual)
                let weekGoal = 'D√≠as 1-7';
                let weekColor = 'bg-day-card';
                if (dayNumber >= 8 && dayNumber <= 14) {
                    weekGoal = 'D√≠as 8-14';
                    // Usar un tono ligeramente diferente para visualmente separarlos
                    weekColor = 'bg-purple-200'; 
                } else if (dayNumber >= 15 && dayNumber <= 21) {
                    weekGoal = 'D√≠as 15-21';
                    // Otro tono
                    weekColor = 'bg-purple-300'; 
                }
                
                button.className = `day-button ${weekColor} text-primary-indigo rounded-lg text-2xl hover:bg-indigo-300 transition duration-150`;
                button.innerHTML = `<span class="text-3xl">${dayNumber}</span><span class="absolute top-1 left-2 text-xs font-light text-gray-500">${weekGoal}</span>`;
                button.style.position = 'relative'; // Necesario para posicionar el texto peque√±o
                button.dataset.dayIndex = index;
                button.onclick = () => openDayModal(index);
                gridContainer.appendChild(button);
            });
        }

        /**
         * Parsea el contenido est√°tico de un d√≠a e inyecta un campo de texto (textarea)
         * despu√©s de cada indicador de actividad de diario o ejercicio.
         * @param {string} content - El contenido HTML del d√≠a.
         * @returns {string} El contenido HTML modificado con campos de texto.
         */
        function injectTextAreas(content) {
            // Indicadores que se√±alan d√≥nde insertar el textarea
            const indicators = [
                'üåü Afirmaci√≥n:', '‚úÖ Ejercicio:', '‚úÖ Tarea:', '‚úÖ Pr√°ctica:', '‚úÖ Enfoque Diario:', '‚úÖ Revisi√≥n:',
                '‚úÖ Reconocimiento:', '‚úÖ Ritual:', '‚úÖ Meditaci√≥n Guiada:', '‚úÖ Conciencia Corporal:',
                '‚úçÔ∏è Diario:', 'üéØ Meta:', '‚úÖ Actividad:', '‚úÖ T√©cnica:' // A√±adido '‚úÖ T√©cnica:' para el nuevo d√≠a 13
            ];

            let modifiedContent = content;
            let activityIndex = 0; // Contador para asignar √≠ndices a dayActivities

            indicators.forEach(indicator => {
                const escapedIndicator = indicator.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                
                // Regex: busca el indicador seguido de <p>texto</p> (y repite)
                // Se ajusta para que capture los t√≠tulos de nivel 3 y 4
                const regex = new RegExp(`(<h[34][^>]*>${escapedIndicator}[^<]*<\\/h[34]>\\s*(?:<p[^>]*>[^<]*<\\/p>)?|(<h3[^>]*>‚úÖ Acci√≥n del D√≠a:<\\/h3>\\s*<p>[^<]*<\\/p>))`, 'gs');


                // Reemplaza cada coincidencia con el contenido original + el textarea con su √≠ndice
                modifiedContent = modifiedContent.replace(regex, (match) => {
                    const textareaHTML = `
                        <textarea class="w-full mt-2 p-2 border border-gray-300 rounded-lg text-sm text-gray-700 focus:ring-2 focus:ring-primary-indigo focus:border-primary-indigo transition duration-150" rows="3" placeholder="Escribe tu reflexi√≥n o respuesta aqu√≠..." data-field="dayActivities" data-activity-index="${activityIndex++}"></textarea>
                    `;
                    return match + textareaHTML;
                });
            });

            return modifiedContent;
        }


        /**
         * Abre el modal con el contenido del d√≠a seleccionado e integra las rutinas fijas/din√°micas.
         * @param {number} index - √çndice del d√≠a (0 a 20).
         */
        async function openDayModal(index) {
            const dayData = dailyContent[index];
            
            // 1. Contenido espec√≠fico del d√≠a con Textareas inyectados
            let contentWithInputs = injectTextAreas(dayData.content);
            
            // 2. L√≥gica para el bot√≥n de Comentario del D√≠a 21
            if (index === 20) { // D√≠a 21 (√≠ndice 20)
                const activeDaysCount = await countActiveDays();
                const commentButtonHtml = getCommentButtonHtml(activeDaysCount);
                contentWithInputs += commentButtonHtml;
            }

            modalTitle.textContent = dayData.title;
            modalDayContent.innerHTML = contentWithInputs;
            
            // 3. Contenido din√°mico de las rutinas (Ma√±ana y Noche)
            const morningRoutine = getMorningRoutineHtml(index);
            
            // 4. Determinar si se a√±ade el bot√≥n de descarga (solo en el D√≠a 21)
            const downloadButton = index === 20 ? DOWNLOAD_BUTTON_HTML : '';

            // 5. Insertar la rutina de la ma√±ana, el bot√≥n de estiramientos, la rutina de noche y el bot√≥n de descarga (condicional).
            modalFixedRoutines.innerHTML = morningRoutine + STRETCHING_BUTTON_HTML + BASE_NIGHT_RELAXATION + downloadButton;

            // 6. Cargar datos y adjuntar listeners de guardado
            await loadDayProgress(index);
            attachInputListeners(index);


            dayContentModal.classList.remove('hidden');
            dayContentModal.classList.add('flex');
        }

        // Exponer funciones para los handlers inline del HTML
        window.downloadProgress = downloadProgress;
        window.openDayModal = openDayModal;
        window.closeDayModal = closeDayModal;
        window.openCrisisModal = openCrisisModal;
        window.closeCrisisModal = closeCrisisModal;
        window.showToast = showToast;


        // Ejecutar la inicializaci√≥n de Firebase y la cuadr√≠cula al cargar la ventana
        window.onload = async () => {
            await initializeFirebase();
            initializeGrid();
        }


    </script>
</body>
</html>
